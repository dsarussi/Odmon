# מסמך מערכת ODMON

---

## 1. מטרה

ODMON הוא שירות אוטומטי שתפקידו לסנכרן נתוני תיקים ממערכת Odcanit (מערכת ניהול תיקים משפטיים) אל לוח Monday.com. המערכת פותרת את הבעיות הבאות:

- חוסר שקיפות — נתוני תיקים מאוחסנים ב-Odcanit בלבד ואינם נגישים לצוותים שאינם עובדים עם המערכת ישירות. ODMON מנגיש את המידע בלוח Monday מרכזי.
- עדכונים ידניים — ללא ODMON, עדכון שדות כגון תאריך דיון, שופט, עיר בית משפט, סכומי נזק וסטטוסים נעשה ידנית ונוטה לטעויות. ODMON מבצע זאת באופן אוטומטי ודטרמיניסטי.
- ניהול דיונים — כאשר נקבע דיון חדש או משתנה דיון קיים, ODMON מזהה את השינוי, מעדכן את Monday, ומאפשר שליחת הודעה ללקוח לקבלת אישור.
- מעקב תשובות — המערכת קולטת תשובות אישור/דחייה מ-Monday ומעדכנת בחזרה את Odcanit.

---

## 2. סקירת מערכות

### Odcanit (קריאה בלבד)

מאגר הנתונים הראשי לתיקים משפטיים. ODMON קורא מ-Views מוגדרים מראש:

- vwExportToOuterSystems_Files — נתוני תיקים בסיסיים
- vwExportToOuterSystems_userdata — נתונים מורחבים
- vwExportToOuterSystems_YomanData — נתוני יומן דיונים
- vwExportToOuterSystems_sides — צדדים (תובע/נתבע)
- vwExportToOuterSystems_Hozlap — חוזלפ (מקרים מורחבים)

ODMON אינו כותב ל-Odcanit. חריג יחיד: כתיבת תשובת לקוח (אישור/דחייה) באמצעות Stored Procedure ייעודי.

### IntegrationDb (בבעלות ODMON)

בסיס נתונים SQL Server שנוצר ומנוהל על ידי ODMON. מכיל:

- MondayItemMappings — מיפוי בין TikCounter לשורה ב-Monday
- SyncLogs — לוגים של ריצות סינכרון
- SyncFailures — רישום כשלונות לצורך מעקב וניסיון חוזר
- SyncRunLocks — נעילת ריצה למניעת חפיפה בין ריצות
- MondayHearingApprovalStates — סטטוס אישור לקוח לדיון
- SkipEvents — אירועים שדולגו (ערכים לא תקינים)
- AllowedTik — רשימת תיקים מורשים לעיבוד

### Monday.com (קופסה שחורה)

לוח Monday "ניהול תיקים" (BoardId: 5035534500). ODMON מתקשר עם Monday דרך GraphQL API בלבד. ODMON אינו משנה את מבנה הלוח, העמודות, התוויות או ההגדרות. Monday מטופל כקופסה שחורה.

### Worker Service

שירות .NET 8 Worker שרץ כשירות רקע. בכל ריצה, המערכת מבצעת מחזור סינכרון מלא.

---

## 3. זרימה מקצה לקצה

### שלב 1: טעינת תיקים

המערכת קוראת את רשימת ה-TikCounters המורשים מהקונפיגורציה. ניתן לציין TikCounters ישירות או TikNumbers שייפתרו אוטומטית.

### שלב 2: העשרה

לכל תיק שנטען, המערכת מעשירה את הנתונים ממספר מקורות — צדדים, חוזלפ, לקוחות, דיונים, ונתוני משתמש.

### שלב 3: גזירת סוג מסמך

סוג המסמך (כתב תביעה, כתב הגנה, מכתב דרישה אילי) נגזר באופן דטרמיניסטי ממספר הלקוח. ערך זה לא קיים ב-Odcanit ומחושב על ידי ODMON בלבד.

### שלב 4: מיפוי ל-Monday

כל תיק ממופה לשורה ב-Monday. המערכת מחפשת מיפוי קיים, ויוצרת שורה חדשה רק אם לא קיים. אם קיים, משווה גרסה ומעדכנת רק אם יש שינוי.

### שלב 5: סינכרון דיונים

המערכת מזהה שינויים בדיונים באמצעות HearingChecksum — חתימה דטרמיניסטית של שדות הדיון. שינוי בחתימה מעדכן את Monday גם אם שאר הנתונים לא השתנו.

### שלב 6: הודעה ללקוח

כאשר תאריך דיון מתעדכן ב-Monday, ניתן להפעיל הודעה ללקוח. הלקוח מאשר או דוחה.

### שלב 7: אישור/דחייה

המערכת קולטת את תשובת הלקוח מ-Monday וכותבת אותה בחזרה ל-Odcanit.

---

## 4. כללים עסקיים קריטיים

### תנאי שליחת תאריך ושעת דיון

עדכון תאריך ושעת דיון ב-Monday מפעיל הודעה ללקוח. לכן, המערכת לא תשלח תאריך/שעה אלא אם:

- קיים שם שופט (HearingJudgeName)
- קיימת עיר בית משפט אפקטיבית (EffectiveCourtCity)
- סטטוס הדיון אינו "מבוטל"

שדות אחרים (שם שופט, עיר) מתעדכנים באופן עצמאי.

### סטטוס "דיון התבטל?"

- MeetStatus = 1 (מבוטל) — נשלח "מבוטל"
- MeetStatus = 2 (העברה) — נשלח "הועבר"
- MeetStatus = 0 (פעיל) או null (אין דיון) — העמודה לא נשלחת כלל

### לקוח 6 — התנהגות מיוחדת

עבור תיקים ששייכים ללקוח מספר 6, עמודת סוג מסמך לא נשלחת ל-Monday.

### Monday כקופסה שחורה

ODMON לא משנה את מבנה הלוח ב-Monday. אם עמודה לא קיימת — היא מדולגת. אם ערך לא תואם לתוויות מותרות — הרשומה נחסמת עם שגיאה.

---

## 5. תדירות ריצה ותזמון

### תדירות ריצה מומלצת

ריצה כל 20 דקות. ניתן להגדיר באמצעות Sync:IntervalSeconds בקונפיגורציה.

### מניעת חפיפה בין ריצות

המערכת כוללת מנגנון נעילה מבוסס בסיס נתונים (טבלת SyncRunLocks). כל ריצה נועלת את הטבלה בתחילתה ומשחררת בסופה. אם ריצה קודמת לא הסתיימה (קריסה), הנעילה פוקעת אוטומטית לאחר 30 דקות.

חשוב: אם יש שתי מופעים של השירות פועלים במקביל, רק אחד מהם יעבד בכל מחזור. השני ידלג וירשום הודעה ביומן.

---

## 6. טיפול בכשלונות

### כשלונות חלקיים

כל תיק מעובד בנפרד בתוך try/catch. כשלון בתיק אחד אינו עוצר את עיבוד שאר התיקים. המערכת ממשיכה ומדווחת בסיכום הריצה.

### ניסיון חוזר אוטומטי

עבור כשלונות חולפים בלבד (תקלות רשת, שגיאת 429 מ-Monday, שגיאות שרת 5xx, deadlock ב-SQL):

- עד 3 ניסיונות חוזרים
- השהיה מדורגת: 1 שנייה, 4 שניות, 12 שניות
- לאחר מיצוי הניסיונות, התיק נרשם ככשלון

כשלונות שאינם חולפים (שגיאת תקינות, ערך לא תקין, שדה חסר) אינם מנוסים שוב.

### מעקב כשלונות (Dead Letter)

כל תיק שנכשל נרשם בטבלת SyncFailures שכוללת:

- RunId — מזהה ריצה
- TikCounter, TikNumber — זיהוי התיק
- Operation — הפעולה שנכשלה (create / update / process_case)
- ErrorType, ErrorMessage — פרטי השגיאה
- OccurredAtUtc — מועד הכשלון
- RetryAttempts — מספר ניסיונות חוזרים שבוצעו
- Resolved — האם הטופל בריצה מאוחרת יותר

ניתן לתשאל טבלה זו כדי לראות תיקים שנכשלו ואילו שגיאות התקבלו.

### התראות

המערכת כוללת מנגנון התראות מותאם (ממשק IErrorNotifier). כרגע מופעלת התראה באמצעות לוגים בלבד. ניתן להחליף למשלוח דוא"ל או webhook בעתיד.

התראה מופעלת ב:
- קריסה של השירות עצמו (חריגה בלתי צפויה)
- שיעור כשלונות גבוה (מעל 50% מהתיקים בריצה)

---

## 7. אמינות ובטיחות

### מניעת "נפילה בין הכיסאות"

- כל תיק שנטען מעובד, ללא קשר לתוצאת תיקים אחרים
- כשלונות נרשמים בטבלה ייעודית לצורך מעקב
- בכל ריצה מתעדכן רישום בטבלת SyncLogs עם סיכום מלא
- שורת HEARTBEAT בלוג מעידה על סיום כל ריצה

### אידמפוטנטיות

- המערכת לא מעדכנת ערכים ב-Monday אם הם זהים לערכים הקיימים
- HearingChecksum מבטיח שעדכון דיון נשלח רק כאשר יש שינוי בפועל
- OdcanitVersion מבטיח שעדכון נתוני תיק נשלח רק כאשר השתנו ב-Odcanit
- הרצה חוזרת לא תיצור כפילויות ולא תשלח עדכונים מיותרים

### בטיחות הרצה חוזרת

- ניתן להריץ את המערכת בכל רגע ללא חשש לנזק
- המערכת תזהה שאין שינויים ותדלג
- אם הריצה הקודמת נכשלה באמצע, הריצה הבאה תטפל בתיקים שנותרו

---

## 8. מדדים וביצועים

בכל ריצה, המערכת מודדת ורושמת בלוגים את הזמנים הבאים:

- ResolveTikCounters — פתרון רשימת תיקים
- LoadCases — טעינה מ-Odcanit
- DeriveDocumentType — חישוב סוג מסמך
- PerCaseProcessing — עיבוד כל התיקים (סה"כ)
- HearingApprovalSync — סינכרון אישורים
- HearingNearestSync — סינכרון דיונים קרובים
- זמן עיבוד לכל תיק בנפרד (ברמת debug)

בסיכום הריצה מופיעים:
- Total — סה"כ תיקים
- Success — הצליחו (נוצרו + עודכנו + דולגו ללא שינוי)
- Created — נוצרו חדשים
- Updated — עודכנו
- SkippedNoChange — דולגו (ללא שינוי)
- Failed — נכשלו
- Duration — משך הריצה בשניות

---

## 9. פתרון בעיות

### אם נראה שתיק לא מתעדכן

1. בדקו בלוגים את ה-RunId האחרון — חפשו את ה-TikCounter הרלוונטי
2. בדקו האם התיק מופיע ב-Allowlist
3. בדקו האם סטטוס הפעולה הוא "skipped_no_change"
4. בדקו בטבלת SyncFailures האם יש כשלון

### אם דיון לא מתעדכן ב-Monday

1. בדקו בלוגים את שורת "Hearing gating" — האם מופיעים שם שופט ועיר
2. אם חסר שם שופט או עיר — התאריך/שעה לא יישלחו (מכוון)
3. בדקו את HearingChecksum — אם לא השתנה, לא יישלח עדכון

### בדיקת בריאות המערכת

- חפשו בלוגים את שורת "HEARTBEAT" — מופיעה בסוף כל ריצה
- חפשו "SYNC RUN SUMMARY" — מציגה Total/Success/Failed/Duration
- אם לא מופיע HEARTBEAT במשך 40 דקות — ייתכן שהשירות לא רץ

### איפה כשלונות נרשמים

- טבלת SyncFailures — כשלונות עם פרטי שגיאה מלאים
- טבלת SyncLogs — סיכום כל ריצה
- טבלת SkipEvents — תיקים שדולגו בגלל ערכים לא תקינים

---

## 10. מה מותר ומה אסור — למפעילים

### מותר

- להפעיל מחדש את השירות בכל רגע — אין סכנה לכפילויות
- לבדוק את טבלת SyncFailures כדי לראות כשלונות
- לשנות ערכים ב-Odcanit — ODMON יזהה וישלח ל-Monday בריצה הבאה
- לשנות ערכים ב-Monday ידנית — ODMON לא ידרוס ערכים שלא השתנו ב-Odcanit

### אסור

- אל תשנו את מבנה הלוח ב-Monday (עמודות, תוויות, קבוצות) בלי תיאום
- אל תמחקו שורות מ-MondayItemMappings — זה עלול ליצור כפילויות
- אל תעצרו את השירות לתקופה ארוכה — דיונים חדשים לא יתעדכנו
- אל תריצו שני מופעים של השירות על אותו בסיס נתונים — מנגנון הנעילה יחסום רק את אחד מהם

---

## 11. מילון מונחים

- **TikNumber** — מספר תיק מוצג (לדוגמה: "9/1858"). משמש לזיהוי חיצוני.
- **TikCounter** — מזהה פנימי מספרי של התיק ב-Odcanit. משמש כמפתח ראשי לסינכרון.
- **BoardId** — מזהה הלוח ב-Monday.com. בסביבת הייצור: 5035534500.
- **MondayItemMappings** — טבלת מיפוי שמקשרת TikCounter לשורה ב-Monday.
- **HearingChecksum** — חתימה של שדות הדיון. שינוי בחתימה מעדכן את Monday.
- **Hearing Status** — סטטוס דיון: 0=פעיל, 1=מבוטל, 2=הועבר.
- **EffectiveCourtCity** — עיר בית משפט אפקטיבית מנתוני הדיון.
- **SyncFailures** — טבלת כשלונות. כל תיק שנכשל נרשם כאן.
- **SyncRunLock** — נעילת ריצה שמונעת שתי ריצות במקביל.
- **Gating** — מנגנון שמונע שליחת תאריך/שעת דיון ללא נתונים מלאים.
- **DryRun** — מצב הרצה יבשה שבו לא נשלחים שינויים ל-Monday.
- **Allowlist** — רשימת תיקים מורשים בקונפיגורציה.
- **HEARTBEAT** — שורת לוג שמעידה על סיום ריצה תקינה.

---

מסמך זה מתעדכן בהתאם לשינויים בקוד ובלוגיקה העסקית.
